<!DOCTYPE html>
<html lang="en">
<head>
  <title>Fixation — Core Module (v2) | Free HTL Guide</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Fixation module with interactive quiz." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --brand:#0F4C81; --text:#1E293B; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:.75rem; font-weight:600; }
    .btn-brand{ background:var(--brand); color:#fff; } .btn-ghost{ border:1px solid #CBD5E1; }
    .pill{ padding:.15rem .5rem; border-radius:999px; background:#EEF2FF; color:#1E3A8A; font-size:.8rem; }
    .toc a{ color:#334155; } .toc a.active{ color:var(--brand); font-weight:600; }
    .correct{ background:#DEF7EC; } .incorrect{ background:#FEE2E2; }
    @media print{ header,.toc,nav,footer,.btn,#progress{ display:none !important; } main{ max-width:100% !important; } }
    #progress{ position:sticky; top:0; left:0; height:4px; z-index:40; background:linear-gradient(to right,var(--brand) var(--pct,0%),#E5E7EB 0); }
  </style>
</head>
<body class="antialiased text-[color:var(--text)]">
  <div id="progress" aria-hidden="true"></div>
  <header class="border-b border-slate-200 bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 h-16 flex items-center justify-between">
      <a href="../index.html" class="font-bold text-lg text-[color:var(--brand)]">Free HTL Guide</a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="../index.html#syllabus" class="hover:text-[color:var(--brand)]">Syllabus</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 md:py-8 grid md:grid-cols-[220px,1fr] gap-8">
    <aside class="toc hidden md:block sticky top-24 self-start">
      <div class="p-4 rounded-xl border border-slate-200 bg-white">
        <p class="text-xs font-semibold tracking-wide text-slate-500">ON THIS PAGE</p>
        <ul class="mt-3 space-y-2 text-sm">
          <li><a href="#top">Top</a></li>
          <li><a href="#quiz">Quiz</a></li>
          <li><a href="#downloads">Downloads</a></li>
        </ul>
      </div>
    </aside>

    <article id="content">
      <section id="top" class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold">Fixation — Core Module</h1>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
            <span class="pill">Fixation</span> <span class="pill">Core</span>
            <span id="bestChip" class="hidden pill bg-green-100 text-green-700">Completed • <span id="bestScore">0%</span></span>
          </div>
        </div>
        <button id="done" class="btn btn-ghost">Mark complete</button>
      </section>

      <section id="quiz" class="mt-10">
        <h2 class="text-2xl font-bold">Practice quiz (15)</h2>
        <form class="mt-3 grid gap-5 max-w-3xl" id="quizForm" aria-describedby="quizDesc">
          <p id="quizDesc" class="sr-only">Select the best option for each question. You can submit and retry.</p>
        </form>
        <div class="mt-3 flex gap-3">
          <button type="button" class="btn btn-brand" onclick="grade()">Submit</button>
          <button type="button" class="btn btn-ghost" onclick="retry()">Retry</button>
        </div>
        <div id="quizResult" class="hidden mt-4 p-4 rounded-xl border border-slate-200" aria-live="polite"></div>
      </section>

      <section id="downloads" class="mt-10">
        <h2 class="text-2xl font-bold">Downloads</h2>
        <div class="mt-3 flex flex-wrap gap-3">
          <a class="btn btn-ghost" href="../assets/Fixation_Quick_Card.pdf">Quick-card (PDF)</a>
          <a class="btn btn-ghost" href="../assets/Pigment_Removal_OnePager.pdf">Pigment removal (PDF)</a>
          <a class="btn btn-ghost" href="../assets/NBF_Prep_Worksheet.pdf">NBF worksheet (PDF)</a>
          <a class="btn btn-ghost" href="../assets/IHC_Validation_Checklist.pdf">IHC/ISH checklist (PDF)</a>
          <a class="btn btn-brand" href="../assets/all-fixation-downloads.zip">All downloads (ZIP)</a>
        </div>
      </section>
    </article>
  </main>

  <footer class="py-10 border-t border-slate-200">
    <div class="mx-auto max-w-6xl px-4 text-slate-600">© <span id="y"></span> Free HTL Guide</div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const prog = document.getElementById('progress');
    document.addEventListener('scroll', () => {
      const h = document.documentElement;
      const p = (h.scrollTop)/(h.scrollHeight - h.clientHeight) * 100;
      prog.style.setProperty('--pct', p + '%');
    });

    // TOC active (guarded so a failure here doesn't break the quiz)
    try {
      if ('IntersectionObserver' in window) {
        const tocLinks = Array.from(document.querySelectorAll('.toc a'));
        const sections = Array.from(document.querySelectorAll('section[id]'));
        const obs = new IntersectionObserver((entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting) {
              tocLinks.forEach((a) => a.classList.remove('active'));
              const hit = tocLinks.find(
                (a) => a.getAttribute('href') === '#' + e.target.id
              );
              if (hit) hit.classList.add('active');
            }
          });
        }, { rootMargin: '-40% 0px -50% 0px', threshold: 0 });
        sections.forEach((s) => obs.observe(s));
      }
    } catch (err) {
      console.warn('TOC observer disabled:', err);
    }

    const DONE_KEY='htl_done_fixation_core';
    const doneBtn=document.getElementById('done');
    function setDone(v){ localStorage.setItem(DONE_KEY, v?'1':'0'); doneBtn.textContent = v?'Completed ✓':'Mark complete'; }
    setDone(localStorage.getItem(DONE_KEY)==='1');
    doneBtn.onclick=()=>setDone(!(localStorage.getItem(DONE_KEY)==='1'));

    // Quiz
    let QUESTIONS = [
      ["The primary chemical action of formaldehyde is:", ["Coagulation of proteins","Oxidation of lipids","Crosslinking of proteins via methylene bridges","Hydrolysis of nucleic acids"], "C"],
      ["Most critical pre-analytic control for small GI biopsies:", ["High paraffin temperature","Minimized time to fixation","Prolonged water bath float time","Use of zinc salts"], "B"],
      ["Brown-black granular pigment after long acidic formalin storage is:", ["Melanin","Formalin pigment (acid hematin)","Hemosiderin","Carbon"], "B"],
      ["Best removal for mercury pigment:", ["Saturated alcoholic lithium carbonate","Potassium permanganate","Iodine followed by sodium thiosulfate","Hydrogen peroxide"], "C"],
      ["Fixative class causing shrinkage but rapid nuclear preservation:", ["Dialdehydes","Alcohols","Aldehydes","Osmium tetroxide"], "B"],
      ["Best decalcification for IHC-heavy bone marrow:", ["Strong HCl","Formic acid with heat","EDTA at room temperature","Trichloroacetic acid"], "C"],
      ["Switching from NBF to glyoxal-based: first step for IHC quality:", ["Increase antibody concentration twofold","Run parallel validation with known controls","Shorten retrieval by half","Skip on-slide controls"], "B"],
      ["Bouin's solution improves:", ["Myelin sheaths in CNS","Collagen/CT architecture for trichromes","Bacterial walls in Gram","Elastin fibers in VVG"], "B"],
      ["Recommended fixative:tissue volume ratio:", ["2:1","5:1","10:1","20:1"], "C"],
      ["Over-retrieval in IHC after long fixation causes:", ["Enhanced specific signal only","Loss of morphology/high background","No change","Stronger nuclear counterstain"], "B"],
      ["To minimize brittle sections from over-fixed tissue:", ["Raise water bath to 55-60 C","Soften block (ice/glycerol), trim thinner, adjust angle","Prolong xylene clearing","Use a coarser blade"], "B"],
      ["Typical pH of standard NBF:", ["5.0-5.5","7.0-7.2","8.5-9.0","10.5-11.0"], "B"],
      ["Pre-analytic factor that most affects ISH integrity:", ["Float time at 45 C","Cold ischemia and fixation duration","Type of coverslip mountant","Block thickness only"], "B"],
      ["Pap smear with air-dry artifact reflects failure in:", ["Buffer pH control","Alcohol concentration","Immediate fixation","Proper dehydration"], "C"],
      ["Preparing 1 L of 10% NBF (~4% formaldehyde) from 37% stock requires:", ["27 mL","54 mL","108 mL","250 mL"], "C"]
    ];

    const EXPL = [
      "Formaldehyde forms methylene bridges (crosslinks).",
      "Cold ischemia time is critical; minimize time to fixation.",
      "Classic acid hematin from acidic formalin/long fixation.",
      "Iodine -> sodium thiosulfate removes mercury pigment.",
      "Coagulants (alcohols) cause shrinkage but act fast.",
      "EDTA best preserves antigen/nucleic acids for IHC/ISH.",
      "Parallel validation maintains quality when changing pre-analytics.",
      "Bouin's enhances connective tissue contrast for trichromes.",
      "Rule of thumb is ~10:1.",
      "Too much retrieval damages morphology and increases background.",
      "Softening and mechanical adjustments reduce chatter.",
      "NBF is ~neutral pH.",
      "ISH is sensitive to cold ischemia and fixation duration.",
      "Pap smears require immediate fixation to prevent air-drying.",
      "C1V1=C2V2 -> (4/37)*1000 ~ 108 mL."
    ];

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]]; } }
    function shuffledOptions(opts){ const arr = opts.map((opt,i)=>({opt,letter:String.fromCharCode(65+i)})); shuffle(arr); return arr; }

    const form = document.getElementById('quizForm');
    function renderQuiz(){
      form.innerHTML = "";
      shuffle(QUESTIONS);
      QUESTIONS.forEach((q, idx) => {
        const [stem, options] = q;
        const num = idx + 1;
        const fs = document.createElement('fieldset'); fs.className = "mt-2";
        const lg = document.createElement('legend'); lg.className = "font-medium"; lg.textContent = num+") "+stem; fs.appendChild(lg);
        const opts = shuffledOptions(options);
        opts.forEach((o) => {
          const label = document.createElement('label'); label.className = "block mt-1";
          const input = document.createElement('input'); input.type = "radio"; input.name = "q"+num; input.value = String.fromCharCode(65 + options.indexOf(o.opt));
          label.appendChild(input); label.appendChild(document.createTextNode(" "+o.opt)); fs.appendChild(label);
        });
        form.appendChild(fs);
      });
    }
    renderQuiz();

    const KEY = {}; function buildKey(){ QUESTIONS.forEach((q, idx)=>{ KEY["q"+(idx+1)] = q[2]; }); }; buildKey();

    const BEST_KEY='htl_best_fixation_score';
    function updateBestChip(){ const best = parseInt(localStorage.getItem(BEST_KEY)||"0",10); if(best>0){ document.getElementById('bestScore').textContent = best + "%"; document.getElementById('bestChip').classList.remove('hidden'); } } updateBestChip();

    function grade(){
      let score=0, total=QUESTIONS.length;
      const blocks = form.querySelectorAll('fieldset');
      blocks.forEach((fs, i) => { const correct = KEY["q"+(i+1)]; const chosen = fs.querySelector("input:checked"); fs.classList.remove('correct','incorrect'); if(chosen && chosen.value===correct){ score++; fs.classList.add('correct'); } else { fs.classList.add('incorrect'); } });
      const pct = Math.round((score/total)*100);
      const res = document.getElementById('quizResult');
      res.classList.remove('hidden');
      res.innerHTML = "<strong>Score: "+score+"/"+total+" ("+pct+"%)</strong><div class='mt-2 text-sm text-slate-700'>"+ EXPL.map((e, i) => "Q"+(i+1)+": "+e).join("<br>")+"</div>";
      try { const best = Math.max(pct, parseInt(localStorage.getItem(BEST_KEY)||"0",10)); localStorage.setItem(BEST_KEY, best); } catch(e){}
      updateBestChip();
      window.scrollTo({ top: res.offsetTop - 80, behavior: 'smooth' });
    }
    function retry(){ renderQuiz(); buildKey(); document.getElementById('quizResult').classList.add('hidden'); window.scrollTo({ top: document.getElementById('quiz').offsetTop - 80, behavior: 'smooth' }); }
    window.grade = grade; window.retry = retry;

    // Safety net: render quiz after DOM is ready even if earlier code hiccups
    window.addEventListener('DOMContentLoaded', function () {
      if (typeof renderQuiz === 'function') { try { renderQuiz(); } catch (e) { console.error(e); } }
      if (typeof buildKey === 'function') { try { buildKey(); } catch (e) { console.error(e); } }
    });
  </script>
</body>
</html>
