<!DOCTYPE html>
<html lang="en">
<head>
  <title>Processing - Core Module | Free HTL Guide</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Processing module with interactive quiz." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --brand:#0F4C81; --text:#1E293B; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:.75rem; font-weight:600; }
    .btn-brand{ background:var(--brand); color:#fff; } .btn-ghost{ border:1px solid #CBD5E1; }
    .pill{ padding:.15rem .5rem; border-radius:999px; background:#EEF2FF; color:#1E3A8A; font-size:.8rem; }
    .toc a{ color:#334155; } .toc a.active{ color:var(--brand); font-weight:600; }
    .correct{ background:#DEF7EC; } .incorrect{ background:#FEE2E2; }
    @media print{ header,.toc,nav,footer,.btn,#progress{ display:none !important; } main{ max-width:100% !important; } }
    #progress{ position:sticky; top:0; left:0; height:4px; z-index:40; background:linear-gradient(to right,var(--brand) var(--pct,0%),#E5E7EB 0); }
  </style>
</head>
<body class="antialiased text-[color:var(--text)]">
  <div id="progress" aria-hidden="true"></div>
  <header class="border-b border-slate-200 bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 h-16 flex items-center justify-between">
      <a href="../index.html" class="font-bold text-lg text-[color:var(--brand)]">Free HTL Guide</a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="../index.html#syllabus" class="hover:text-[color:var(--brand)]">Syllabus</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 md:py-8 grid md:grid-cols-[220px,1fr] gap-8">
    <aside class="toc hidden md:block sticky top-24 self-start">
      <div class="p-4 rounded-xl border border-slate-200 bg-white">
        <p class="text-xs font-semibold tracking-wide text-slate-500">ON THIS PAGE</p>
        <ul class="mt-3 space-y-2 text-sm">
          <li><a href="#top">Top</a></li>
          <li><a href="#quiz">Quiz</a></li>
          <li><a href="#downloads">Downloads</a></li>
        </ul>
      </div>
    </aside>

    <article id="content">
      <section id="top" class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold">Processing - Core Module</h1>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
            <span class="pill">Processing</span> <span class="pill">Core</span>
            <span id="bestChip" class="hidden pill bg-green-100 text-green-700">Completed - <span id="bestScore">0%</span></span>
          </div>
        </div>
        <button id="done" class="btn btn-ghost">Mark complete</button>
      </section>

      <section id="quiz" class="mt-10">
        <h2 class="text-2xl font-bold">Practice quiz (15)</h2>
        <form class="mt-3 grid gap-5 max-w-3xl" id="quizForm" aria-describedby="quizDesc">
          <p id="quizDesc" class="sr-only">Select the best option for each question. You can submit and retry.</p>
        </form>
        <div class="mt-3 flex gap-3">
          <button type="button" class="btn btn-brand" onclick="grade()">Submit</button>
          <button type="button" class="btn btn-ghost" onclick="retry()">Retry</button>
        </div>
        <div id="quizResult" class="hidden mt-4 p-4 rounded-xl border border-slate-200" aria-live="polite"></div>
      </section>

      <section id="downloads" class="mt-10">
        <h2 class="text-2xl font-bold">Downloads</h2>
        <div class="mt-3 flex flex-wrap gap-3">
          <a class="btn btn-ghost" href="../assets/Processing_Quick_Card.pdf">Quick-card (PDF)</a>
          <a class="btn btn-ghost" href="../assets/Processing_Schedules.pdf">Schedules (PDF)</a>
          <a class="btn btn-ghost" href="../assets/Processing_Troubleshooting.pdf">Troubleshooting (PDF)</a>
          <a class="btn btn-ghost" href="../assets/Reagent_Rotation_Log.pdf">Rotation log (PDF)</a>
          <a class="btn btn-brand" href="../assets/all-processing-downloads.zip">All downloads (ZIP)</a>
        </div>
      </section>
    </article>
  </main>

  <footer class="py-10 border-t border-slate-200">
    <div class="mx-auto max-w-6xl px-4 text-slate-600">© <span id="y"></span> Free HTL Guide</div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const prog = document.getElementById('progress');
    document.addEventListener('scroll', () => {
      const h = document.documentElement;
      const p = (h.scrollTop)/(h.scrollHeight - h.clientHeight) * 100;
      prog.style.setProperty('--pct', p + '%');
    });

    // TOC active (guarded so a failure here doesn't break the quiz)
    try {
      if ('IntersectionObserver' in window) {
        const tocLinks = Array.from(document.querySelectorAll('.toc a'));
        const sections = Array.from(document.querySelectorAll('section[id]'));
        const obs = new IntersectionObserver((entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting) {
              tocLinks.forEach((a) => a.classList.remove('active'));
              const hit = tocLinks.find(
                (a) => a.getAttribute('href') === '#' + e.target.id
              );
              if (hit) hit.classList.add('active');
            }
          });
        }, { rootMargin: '-40% 0px -50% 0px', threshold: 0 });
        sections.forEach((s) => obs.observe(s));
      }
    } catch (err) {
      console.warn('TOC observer disabled:', err);
    }

    const DONE_KEY='htl_done_processing_core';
    const doneBtn=document.getElementById('done');
    function setDone(v){ localStorage.setItem(DONE_KEY, v?'1':'0'); doneBtn.textContent = v?'Completed ✓':'Mark complete'; }
    setDone(localStorage.getItem(DONE_KEY)==='1');
    doneBtn.onclick=()=>setDone(!(localStorage.getItem(DONE_KEY)==='1'));

    // Quiz bank
    let QUESTIONS = [
      ["Primary purpose of dehydration:", ["Remove free water","Replace fat with solvent","Infuse paraffin","Fix nucleic acids"], "A"],
      ["Two 100% alcohol stations primarily reduce:", ["Over-dehydration","Water carryover","Brittleness","Heat damage"], "B"],
      ["Xylene substitutes often require:", ["No clearing steps","Longer times vs xylene","Lower paraffin temps","Skipping 100% alcohol"], "B"],
      ["Typical paraffin melting point range:", ["40-45 deg C","50-55 deg C","56-60 deg C","65-70 deg C"], "C"],
      ["Opaque paraffin around tissue suggests:", ["Overheating paraffin","Water carryover","Too much vacuum","Dirty molds"], "B"],
      ["Soft/spongy block likely due to:", ["Under-dehydration/clearing","Over-dehydration","Excess xylene","Low paraffin MP"], "A"],
      ["Brittle/shrunken tissue likely due to:", ["Under-dehydration","Over-clearing and long 100% alcohol","Low bath temperature","Too little vacuum"], "B"],
      ["For fatty tissue you should usually:", ["Shorten clearant steps","Use only one paraffin station","Extend clearant/paraffin, consider vacuum","Skip 70% alcohol"], "C"],
      ["Carryover control best practice:", ["Single 100% alcohol then xylene","Two 100% alcohols and two clearants","Skip 95% alcohol for speed","Reduce agitation"], "B"],
      ["Best immediate fix for soft block:", ["Re-embed without changes","Repeat from 95% alcohol, extend clearant, reinfiltrate","Cool block longer","Change microtome angle"], "B"],
      ["Evidence of reagent exhaustion:", ["Clear, colorless xylene","Alcohol stations reading 0% water","Cloudy clearant or paraffin","Stable processing times"], "C"],
      ["To protect antigens for IHC:", ["Use very hot paraffin >65 deg C","Limit over-dehydration and overheating","Switch to methanol for all steps","Always skip vacuum"], "B"],
      ["Dense/calcified tissue needs:", ["Shorter alcohol steps","Longer dehydration/clearing and thin grossing","Fewer paraffin steps","Higher water content"], "B"],
      ["Best practice for logs:", ["No documentation needed","Note only reagent lot numbers","Track rotation dates, lots, temps, actions","Track only xylene"], "C"],
      ["When using substitutes:", ["Assume times equal to xylene","Verify compatibility with paraffin and extend times as needed","Reduce number of stations","Use colder paraffin"], "B"]
    ];

    const EXPL = [
      "Dehydration removes water so clearant and paraffin can replace it.",
      "Reduces water carryover into clearant and wax.",
      "Substitutes often clear more slowly; check manufacturer guidance.",
      "Most paraffin histology waxes melt around 56-60 deg C.",
      "Water in the workflow clouds paraffin around tissue.",
      "Insufficient dehydration/clearing leaves tissue soft/spongy.",
      "Excess dehydration/clearing and heat cause brittleness/shrinkage.",
      "Fat benefits from longer clearant/paraffin and vacuum.",
      "Two absolutes and two clearants are standard to limit carryover.",
      "Reprocess: 95% -> absolutes -> clearant -> paraffin with extra time.",
      "Cloudiness suggests contamination or water; refresh/rotate.",
      "Avoid overheating and excessive dehydration for IHC integrity.",
      "Dense tissue needs longer steps and thin grossing.",
      "Logs should record rotation/refresh, lots, temperature, actions.",
      "Times can differ; ensure paraffin compatibility."
    ];

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]]; } }
    function shuffledOptions(opts){ const arr = opts.map((opt,i)=>({opt,letter:String.fromCharCode(65+i)})); shuffle(arr); return arr; }

    const form = document.getElementById('quizForm');
    function renderQuiz(){
      form.innerHTML = "";
      shuffle(QUESTIONS);
      QUESTIONS.forEach((q, idx) => {
        const [stem, options] = q;
        const num = idx + 1;
        const fs = document.createElement('fieldset'); fs.className = "mt-2";
        const lg = document.createElement('legend'); lg.className = "font-medium"; lg.textContent = num+") "+stem; fs.appendChild(lg);
        const opts = shuffledOptions(options);
        opts.forEach((o) => {
          const label = document.createElement('label'); label.className = "block mt-1";
          const input = document.createElement('input'); input.type = "radio"; input.name = "q"+num; input.value = String.fromCharCode(65 + options.indexOf(o.opt));
          label.appendChild(input); label.appendChild(document.createTextNode(" "+o.opt)); fs.appendChild(label);
        });
        form.appendChild(fs);
      });
    }
    renderQuiz();

    const KEY = {}; function buildKey(){ QUESTIONS.forEach((q, idx)=>{ KEY["q"+(idx+1)] = q[2]; }); }; buildKey();

    const BEST_KEY='htl_best_processing_score';
    function updateBestChip(){ const best = parseInt(localStorage.getItem(BEST_KEY)||"0",10); if(best>0){ document.getElementById('bestScore').textContent = best + "%"; document.getElementById('bestChip').classList.remove('hidden'); } } updateBestChip();

    function grade(){
      let score=0, total=QUESTIONS.length;
      const blocks = form.querySelectorAll('fieldset');
      blocks.forEach((fs, i) => { const correct = KEY["q"+(i+1)]; const chosen = fs.querySelector("input:checked"); fs.classList.remove('correct','incorrect'); if(chosen && chosen.value===correct){ score++; fs.classList.add('correct'); } else { fs.classList.add('incorrect'); } });
      const pct = Math.round((score/total)*100);
      const res = document.getElementById('quizResult');
      res.classList.remove('hidden');
      res.innerHTML = "<strong>Score: "+score+"/"+total+" ("+pct+"%)</strong><div class='mt-2 text-sm text-slate-700'>"+ EXPL.map((e, i) => "Q"+(i+1)+": "+e).join("<br>")+"</div>";
      try { const best = Math.max(pct, parseInt(localStorage.getItem(BEST_KEY)||"0",10)); localStorage.setItem(BEST_KEY, best); } catch(e){}
      updateBestChip();
      window.scrollTo({ top: res.offsetTop - 80, behavior: 'smooth' });
    }
    function retry(){ renderQuiz(); buildKey(); document.getElementById('quizResult').classList.add('hidden'); window.scrollTo({ top: document.getElementById('quiz').offsetTop - 80, behavior: 'smooth' }); }
    window.grade = grade; window.retry = retry;

    // Safety net: render quiz after DOM is ready even if earlier code hiccups
    window.addEventListener('DOMContentLoaded', function () {
      if (typeof renderQuiz === 'function') { try { renderQuiz(); } catch (e) { console.error(e); } }
      if (typeof buildKey === 'function') { try { buildKey(); } catch (e) { console.error(e); } }
    });
  </script>
<!-- QUIZ FIX PATCH for Processing: renders questions even if earlier scripts fail -->
<script>
(function () {
  function $(id){ return document.getElementById(id); }
  var form = $('quizForm');
  if (!form) return;                 // no quiz form on this page
  if (form.querySelector('fieldset')) return; // already rendered by original script

  var QUESTIONS = [
    ["Primary purpose of dehydration:", ["Remove free water","Replace fat with solvent","Infuse paraffin","Fix nucleic acids"], "A"],
    ["Two 100% alcohol stations primarily reduce:", ["Over-dehydration","Water carryover","Brittleness","Heat damage"], "B"],
    ["Xylene substitutes often require:", ["No clearing steps","Longer times vs xylene","Lower paraffin temps","Skipping 100% alcohol"], "B"],
    ["Typical paraffin melting point range:", ["40-45 deg C","50-55 deg C","56-60 deg C","65-70 deg C"], "C"],
    ["Opaque paraffin around tissue suggests:", ["Overheating paraffin","Water carryover","Too much vacuum","Dirty molds"], "B"],
    ["Soft/spongy block likely due to:", ["Under-dehydration/clearing","Over-dehydration","Excess xylene","Low paraffin MP"], "A"],
    ["Brittle/shrunken tissue likely due to:", ["Under-dehydration","Over-clearing and long 100% alcohol","Low bath temperature","Too little vacuum"], "B"],
    ["For fatty tissue you should usually:", ["Shorten clearant steps","Use only one paraffin station","Extend clearant/paraffin, consider vacuum","Skip 70% alcohol"], "C"],
    ["Carryover control best practice:", ["Single 100% alcohol then xylene","Two 100% alcohols and two clearants","Skip 95% alcohol for speed","Reduce agitation"], "B"],
    ["Best immediate fix for soft block:", ["Re-embed without changes","Repeat from 95% alcohol, extend clearant, reinfiltrate","Cool block longer","Change microtome angle"], "B"],
    ["Evidence of reagent exhaustion:", ["Clear, colorless xylene","Alcohol stations reading 0% water","Cloudy clearant or paraffin","Stable processing times"], "C"],
    ["To protect antigens for IHC:", ["Use very hot paraffin >65 deg C","Limit over-dehydration and overheating","Switch to methanol for all steps","Always skip vacuum"], "B"],
    ["Dense/calcified tissue needs:", ["Shorter alcohol steps","Longer dehydration/clearing and thin grossing","Fewer paraffin steps","Higher water content"], "B"],
    ["Best practice for logs:", ["No documentation needed","Note only reagent lot numbers","Track rotation dates, lots, temps, actions","Track only xylene"], "C"],
    ["When using substitutes:", ["Assume times equal to xylene","Verify compatibility with paraffin and extend times as needed","Reduce number of stations","Use colder paraffin"], "B"]
  ];

  var EXPL = [
    "Dehydration removes water so clearant and paraffin can replace it.",
    "Two absolutes limit water carryover into clearant/wax.",
    "Most substitutes clear slower; extend times vs xylene.",
    "Common histology waxes: ~56–60 °C.",
    "Water contamination clouds paraffin around tissue.",
    "Under-dehydration/clearing leaves tissue soft/spongy.",
    "Over-dehydration/clearing + heat causes brittleness/shrinkage.",
    "Fat benefits from longer clearant/paraffin and vacuum.",
    "Two absolutes + two clearants is standard to limit carryover.",
    "Reprocess: 95% → absolutes → clearant → paraffin (extend times).",
    "Cloudy clearant/paraffin suggests contamination/exhaustion.",
    "Protect antigens: avoid overheating and over-dehydration.",
    "Dense/calcified tissue needs longer steps + thin grossing.",
    "Logs: rotation/refresh dates, lots, temps, actions.",
    "Verify paraffin compatibility and adjust times with substitutes."
  ];

  function renderQuiz(){
    form.innerHTML = "";
    for (var i=0;i<QUESTIONS.length;i++){
      var stem = QUESTIONS[i][0], opts = QUESTIONS[i][1], num = i+1;
      var fs = document.createElement('fieldset'); fs.className = "mt-1";
      var lg = document.createElement('legend'); lg.className = "font-medium"; lg.textContent = num + ") " + stem; fs.appendChild(lg);
      for (var k=0;k<opts.length;k++){
        var id = "q"+num+"_"+k;
        var lab = document.createElement('label'); lab.className = "block mt-1"; lab.setAttribute('for', id);
        var input = document.createElement('input'); input.type="radio"; input.id=id; input.name="q"+num; input.value=String.fromCharCode(65+k);
        lab.appendChild(input); lab.appendChild(document.createTextNode(" "+opts[k]));
        fs.appendChild(lab);
      }
      form.appendChild(fs);
    }
  }
  function buildKey(){ var k={}; for (var i=0;i<QUESTIONS.length;i++){ k["q"+(i+1)] = QUESTIONS[i][2]; } return k; }
  var KEY = buildKey();

  window.grade = function(){
    var sets = form.querySelectorAll('fieldset'), score = 0;
    for (var i=0;i<sets.length;i++){
      var fs = sets[i], correct = KEY["q"+(i+1)];
      fs.classList.remove('correct','incorrect');
      var chosen = fs.querySelector('input:checked');
      if (chosen && chosen.value===correct){ score++; fs.classList.add('correct'); }
      else { fs.classList.add('incorrect'); }
    }
    var pct = Math.round(score/sets.length*100);
    var res = document.getElementById('quizResult');
    if (res){
      res.classList.remove('hidden');
      res.innerHTML = "<strong>Score: "+score+"/"+sets.length+" ("+pct+"%)</strong>"
        + "<div class='mt-2 text-sm text-slate-700'>"
        + EXPL.map(function(e,i){ return "Q"+(i+1)+": "+e; }).join("<br>")
        + "</div>";
      window.scrollTo({ top: res.offsetTop-80, behavior: 'smooth' });
    }
  };

  window.retry = function(){
    renderQuiz();
    var res = document.getElementById('quizResult'); if(res) res.classList.add('hidden');
    var q = document.getElementById('quiz') || form;
    window.scrollTo({ top: q.offsetTop-80, behavior: 'smooth' });
  };

  // Render now + on DOM ready (double safety)
  try { renderQuiz(); } catch(e) { console && console.warn("processing quiz immediate render failed", e); }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ try{ renderQuiz(); }catch(e){ console && console.warn("processing quiz DOMContentLoaded render failed", e); } });
  }
})();
</script>
</body>
</html>
